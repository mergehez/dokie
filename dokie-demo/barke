// noinspection SpellCheckingInspection

import * as fs from 'fs';
import * as b from '@mergehez/barke';

const env = b.parseEnv();
const allConfigs = {
    base: {
        sourceBasePath: "./",
        targetBasePath: "/www/wwwroot/dokie.mergesoft.dev",
        targetOS: 'unix',
    } as const,
    ssh: {
        host: env.HOST_SERVER,
        port: parseInt(env.SSH_PORT ?? '22'),
        username: env.SSH_USERNAME,
        password: env.SSH_PASSWORD,
    },
    newFiles: {
        dirsWithManyFiles: [
            'public/build',
            'vendor/composer',
            'storage/framework/cache',
            'storage/framework/views',
            'storage/framework/sessions',
        ],
        ignorePatterns: [
            '/vendor',
            '/bootstrap/cache',
            '.gitignore',
            'node_modules',
            '/tests',
            '/example',
            '/resources/js',
            '/resources/css',
            '/storage/debugbar',
            '*.zip',
            '.git',
            '.idea',
            'hot',
            '.DS_Store',
            'laravel.log',
        ]
    },
    laravelDirsToEnsure: [
        'storage/framework/views',
        'storage/framework/cache',
        'storage/framework/sessions',
        'storage/logs',
        'bootstrap/cache',
        'storage',
    ]
};

async function start() {
    const executer = b.useExecuter(allConfigs.base)
    const server = await executer.sshConnect(allConfigs.ssh)
    const laravel = executer.useLaravelHelpers();

    await server.exec({
        command: 'sudo chown -R www:www ./storage',
        on_error: 'print'
    });
    await server.exec({
        command: 'sudo chown -R www:www ./bootstrap/cache',
        on_error: 'print'
    });
    await laravel.local.clearCache(true);

    await executer.exec({
        command: 'bun run build',
        on_error: 'print'
    })
    await server.deleteFile('public/build/manifest.json', {on_error: 'ignore'});
    await server.deleteDir('public/build/assets', {
        message: 'Deleting old auto-generated vue&js files on server...',
        on_error: 'ignore'
    });
    await server.deleteFile('public/hot', {on_error: 'ignore'});

    const newFiles = await server.findNewFiles({
        ignorePatterns: allConfigs.newFiles.ignorePatterns,
        dirsWithManyFiles: allConfigs.newFiles.dirsWithManyFiles,
        ignoreFn: (path, stat) => {
            return !path.includes('/') && !stat.isDirectory() && path !== 'composer.json' && path !== 'artisan';
        },
    })

    executer.exitIfDryRun();

    executer.deleteLocalFile('barke_deploy_archive.zip', true, 'print');
    const zip = executer.compressFiles(newFiles);

    await server.uploadFile(zip.path);
    await server.unzip(zip.path);
    await server.deleteFile(zip.path);
    zip.deleteLocally();
    if (newFiles.some(f => f.trimmedPath == 'composer.json')) {
        await laravel.server.composerUpdate(server);
    }
    await laravel.local.clearCache(true);
    await laravel.server.ensureDirsExist(server, {
        dirs: allConfigs.laravelDirsToEnsure,
        owner: 'www',
        group: 'www',
        permissions: '0775',
    });
    await laravel.server.optimize(server);
    await server.exec({
        message: 'Setting ownership of storage directory...',
        command: 'sudo chown -R www:www ./storage',
        on_error: 'print'
    })
    await server.exec({
        message: 'Running migrate:fresh on server...',
        command: 'php artisan migrate:fresh --force --seed && sudo chown www:www ./database/database.sqlite',
        on_error: 'print'
    })
    server.dispose();
    executer.finish();
}


const currentVersion = JSON.parse(fs.readFileSync("../packages/laravel/composer.json", "utf-8")).version;
if (!currentVersion) {
    throw new Error("Could not determine laravel version from composer.json");
}

const composerObj = JSON.parse(fs.readFileSync("composer.json", "utf-8"));
composerObj.repositories = [];
composerObj.require["mergehez/dokie"] = `^${currentVersion}`;
fs.writeFileSync("composer.json", JSON.stringify(composerObj, null, 2), 'utf-8');
start().finally(() => {
    composerObj.repositories = [
        {
            "type": "path",
            "url": "../packages/laravel",
            "options": {
                "symlink": true
            }
        }
    ]
    composerObj.require["mergehez/dokie"] = "@dev";
    fs.writeFileSync("composer.json", JSON.stringify(composerObj, null, 2), 'utf-8');
})
